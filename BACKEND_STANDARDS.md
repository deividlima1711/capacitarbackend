# üìã Guia de Padroniza√ß√£o - Backend ProcessFlow

## üéØ Objetivo
Este documento estabelece padr√µes e diretrizes para desenvolvimento, manuten√ß√£o e evolu√ß√£o do backend ProcessFlow, garantindo c√≥digo consistente, seguro e escal√°vel.

## üìÅ Estrutura de Arquivos

```
/
‚îú‚îÄ‚îÄ app.js                 # Ponto de entrada da aplica√ß√£o
‚îú‚îÄ‚îÄ package.json          # Depend√™ncias e scripts
‚îú‚îÄ‚îÄ .env                  # Vari√°veis de ambiente
‚îú‚îÄ‚îÄ README.md             # Documenta√ß√£o do projeto
‚îú‚îÄ‚îÄ BACKEND_STANDARDS.md  # Este documento
‚îú‚îÄ‚îÄ scripts/              # Scripts utilit√°rios
‚îÇ   ‚îú‚îÄ‚îÄ create-admin.js
‚îÇ   ‚îú‚îÄ‚îÄ create-users.js
‚îÇ   ‚îî‚îÄ‚îÄ test-connection.js
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ middleware/       # Middlewares personalizados
    ‚îÇ   ‚îú‚îÄ‚îÄ auth.js
    ‚îÇ   ‚îú‚îÄ‚îÄ validation.js
    ‚îÇ   ‚îî‚îÄ‚îÄ errorHandler.js
    ‚îú‚îÄ‚îÄ models/          # Schemas Mongoose
    ‚îÇ   ‚îú‚îÄ‚îÄ User.js
    ‚îÇ   ‚îú‚îÄ‚îÄ Process.js
    ‚îÇ   ‚îî‚îÄ‚îÄ Task.js
    ‚îú‚îÄ‚îÄ routes/          # Rotas da API
    ‚îÇ   ‚îú‚îÄ‚îÄ auth.js
    ‚îÇ   ‚îú‚îÄ‚îÄ users.js
    ‚îÇ   ‚îú‚îÄ‚îÄ processes.js
    ‚îÇ   ‚îî‚îÄ‚îÄ tasks.js
    ‚îú‚îÄ‚îÄ utils/           # Utilit√°rios e helpers
    ‚îÇ   ‚îú‚îÄ‚îÄ constants.js
    ‚îÇ   ‚îú‚îÄ‚îÄ validators.js
    ‚îÇ   ‚îî‚îÄ‚îÄ helpers.js
    ‚îî‚îÄ‚îÄ config/          # Configura√ß√µes
        ‚îú‚îÄ‚îÄ database.js
        ‚îî‚îÄ‚îÄ cors.js
```

## üîó Padr√µes de Endpoints

### 1. Nomenclatura de URLs
- **Formato**: `/api/v1/{resource}/{id?}/{action?}`
- **Recursos no plural**: `/users`, `/processes`, `/tasks`
- **A√ß√µes espec√≠ficas**: `/users/{id}/activate`, `/processes/{id}/comments`
- **Versionamento**: Sempre incluir vers√£o (`/api/v1/`)

### 2. M√©todos HTTP
- **GET**: Buscar recursos (lista ou item espec√≠fico)
- **POST**: Criar novos recursos
- **PUT**: Atualizar recurso completo
- **PATCH**: Atualiza√ß√£o parcial
- **DELETE**: Remover recurso

### 3. C√≥digos de Status HTTP

```javascript
// Sucesso
200 // OK - Opera√ß√£o bem-sucedida
201 // Created - Recurso criado
204 // No Content - Opera√ß√£o sem retorno

// Erro do Cliente
400 // Bad Request - Dados inv√°lidos
401 // Unauthorized - N√£o autenticado
403 // Forbidden - Sem permiss√£o
404 // Not Found - Recurso n√£o encontrado
409 // Conflict - Conflito de dados
422 // Unprocessable Entity - Valida√ß√£o falhou

// Erro do Servidor
500 // Internal Server Error - Erro interno
503 // Service Unavailable - Servi√ßo indispon√≠vel
```

### 4. Template de Rota Padr√£o

```javascript
const express = require('express');
const { auth, adminAuth } = require('../middleware/auth');
const { validateRequest } = require('../middleware/validation');
const Model = require('../models/Model');

const router = express.Router();

// GET /api/v1/resource - Listar recursos
router.get('/', auth, async (req, res) => {
  try {
    const { 
      page = 1, 
      limit = 10, 
      sort = '-createdAt',
      ...filters 
    } = req.query;

    // Log da opera√ß√£o
    console.log(`üìã Listando recursos - Usu√°rio: ${req.user.username}`);

    // Construir query
    const query = buildQueryFilters(filters);
    
    // Executar consulta com pagina√ß√£o
    const resources = await Model.find(query)
      .populate('relatedField', 'name username email')
      .sort(sort)
      .limit(limit * 1)
      .skip((page - 1) * limit);

    const total = await Model.countDocuments(query);

    // Resposta padronizada
    res.json({
      success: true,
      data: resources,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total,
        totalPages: Math.ceil(total / limit)
      }
    });

  } catch (error) {
    console.error('‚ùå Erro ao listar recursos:', error.message);
    res.status(500).json({ 
      success: false,
      error: 'Erro interno do servidor',
      message: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});

// GET /api/v1/resource/:id - Buscar recurso espec√≠fico
router.get('/:id', auth, async (req, res) => {
  try {
    const { id } = req.params;
    
    console.log(`üîç Buscando recurso ${id} - Usu√°rio: ${req.user.username}`);

    const resource = await Model.findById(id)
      .populate('relatedField', 'name username email');

    if (!resource) {
      return res.status(404).json({ 
        success: false,
        error: 'Recurso n√£o encontrado' 
      });
    }

    res.json({
      success: true,
      data: resource
    });

  } catch (error) {
    console.error('‚ùå Erro ao buscar recurso:', error.message);
    res.status(500).json({ 
      success: false,
      error: 'Erro interno do servidor' 
    });
  }
});

// POST /api/v1/resource - Criar recurso
router.post('/', auth, validateRequest, async (req, res) => {
  try {
    console.log(`‚ú® Criando recurso - Usu√°rio: ${req.user.username}`);

    const resourceData = {
      ...req.body,
      createdBy: req.user._id
    };

    const resource = new Model(resourceData);
    await resource.save();
    
    await resource.populate('relatedField', 'name username email');

    console.log(`‚úÖ Recurso criado: ${resource._id}`);

    res.status(201).json({
      success: true,
      data: resource,
      message: 'Recurso criado com sucesso'
    });

  } catch (error) {
    console.error('‚ùå Erro ao criar recurso:', error.message);
    
    if (error.name === 'ValidationError') {
      return res.status(422).json({ 
        success: false,
        error: 'Dados inv√°lidos',
        details: Object.values(error.errors).map(e => e.message)
      });
    }
    
    res.status(500).json({ 
      success: false,
      error: 'Erro interno do servidor' 
    });
  }
});

module.exports = router;
```

## üìä Padr√µes de Schema (Mongoose)

### 1. Template Base de Schema

```javascript
const mongoose = require('mongoose');

const resourceSchema = new mongoose.Schema({
  // Campos obrigat√≥rios
  title: {
    type: String,
    required: [true, 'T√≠tulo √© obrigat√≥rio'],
    trim: true,
    maxlength: [200, 'T√≠tulo deve ter no m√°ximo 200 caracteres']
  },
  
  // Campos opcionais
  description: {
    type: String,
    trim: true,
    maxlength: [1000, 'Descri√ß√£o deve ter no m√°ximo 1000 caracteres']
  },
  
  // Enums
  status: {
    type: String,
    enum: {
      values: ['ACTIVE', 'INACTIVE', 'PENDING'],
      message: 'Status deve ser ACTIVE, INACTIVE ou PENDING'
    },
    default: 'PENDING'
  },
  
  // Refer√™ncias
  owner: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: [true, 'Propriet√°rio √© obrigat√≥rio']
  },
  
  // Arrays
  tags: [{
    type: String,
    trim: true,
    maxlength: [50, 'Tag deve ter no m√°ximo 50 caracteres']
  }],
  
  // Objetos aninhados
  metadata: {
    category: String,
    priority: {
      type: String,
      enum: ['LOW', 'MEDIUM', 'HIGH', 'URGENT'],
      default: 'MEDIUM'
    }
  },
  
  // Timestamps autom√°ticos
  createdBy: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  updatedBy: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  }
}, {
  timestamps: true, // Adiciona createdAt e updatedAt automaticamente
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// √çndices para performance
resourceSchema.index({ status: 1, createdAt: -1 });
resourceSchema.index({ owner: 1 });
resourceSchema.index({ 'metadata.priority': 1 });

// M√©todos virtuais
resourceSchema.virtual('isActive').get(function() {
  return this.status === 'ACTIVE';
});

// M√©todos de inst√¢ncia
resourceSchema.methods.activate = function() {
  this.status = 'ACTIVE';
  return this.save();
};

// M√©todos est√°ticos
resourceSchema.statics.findActive = function() {
  return this.find({ status: 'ACTIVE' });
};

// Middleware pre-save
resourceSchema.pre('save', function(next) {
  if (this.isModified() && !this.isNew) {
    this.updatedBy = this.constructor.currentUserId;
  }
  next();
});

// Middleware post-save
resourceSchema.post('save', function(doc) {
  console.log(`‚úÖ Recurso salvo: ${doc._id}`);
});

module.exports = mongoose.model('Resource', resourceSchema);
```

### 2. Conven√ß√µes de Nomenclatura

```javascript
// ‚úÖ Correto
{
  firstName: String,        // camelCase para campos
  lastName: String,
  isActive: Boolean,
  createdAt: Date,
  userId: ObjectId,
  phoneNumber: String
}

// ‚ùå Incorreto
{
  first_name: String,       // snake_case
  LastName: String,         // PascalCase
  is_active: Boolean,
  created_at: Date,
  user_id: ObjectId,
  phone_number: String
}
```

## ‚úÖ Valida√ß√£o e Tratamento de Erros

### 1. Middleware de Valida√ß√£o

```javascript
// src/middleware/validation.js
const { body, validationResult } = require('express-validator');

const validateRequest = (req, res, next) => {
  const errors = validationResult(req);
  
  if (!errors.isEmpty()) {
    console.log('‚ùå Valida√ß√£o falhou:', errors.array());
    
    return res.status(422).json({
      success: false,
      error: 'Dados inv√°lidos',
      details: errors.array().map(error => ({
        field: error.path,
        message: error.msg,
        value: error.value
      }))
    });
  }
  
  next();
};

// Valida√ß√µes espec√≠ficas
const userValidation = [
  body('username')
    .isLength({ min: 3, max: 30 })
    .withMessage('Username deve ter entre 3 e 30 caracteres')
    .matches(/^[a-zA-Z0-9_]+$/)
    .withMessage('Username s√≥ pode conter letras, n√∫meros e underscore'),
    
  body('email')
    .isEmail()
    .withMessage('Email inv√°lido')
    .normalizeEmail(),
    
  body('password')
    .isLength({ min: 6 })
    .withMessage('Senha deve ter pelo menos 6 caracteres')
    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
    .withMessage('Senha deve conter ao menos uma letra min√∫scula, mai√∫scula e um n√∫mero')
];

module.exports = { validateRequest, userValidation };
```

### 2. Handler Global de Erros

```javascript
// src/middleware/errorHandler.js
const errorHandler = (err, req, res, next) => {
  console.error('‚ùå Erro capturado:', {
    message: err.message,
    stack: process.env.NODE_ENV === 'development' ? err.stack : undefined,
    url: req.url,
    method: req.method,
    user: req.user?.username
  });

  // Erro do Mongoose - Valida√ß√£o
  if (err.name === 'ValidationError') {
    const errors = Object.values(err.errors).map(e => e.message);
    return res.status(422).json({
      success: false,
      error: 'Dados inv√°lidos',
      details: errors
    });
  }

  // Erro do Mongoose - Cast (ID inv√°lido)
  if (err.name === 'CastError') {
    return res.status(400).json({
      success: false,
      error: 'ID inv√°lido'
    });
  }

  // Erro de duplica√ß√£o (chave √∫nica)
  if (err.code === 11000) {
    const field = Object.keys(err.keyValue)[0];
    return res.status(409).json({
      success: false,
      error: `${field} j√° existe`
    });
  }

  // Erro JWT
  if (err.name === 'JsonWebTokenError') {
    return res.status(401).json({
      success: false,
      error: 'Token inv√°lido'
    });
  }

  if (err.name === 'TokenExpiredError') {
    return res.status(401).json({
      success: false,
      error: 'Token expirado'
    });
  }

  // Erro padr√£o
  res.status(err.statusCode || 500).json({
    success: false,
    error: err.message || 'Erro interno do servidor',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
};

module.exports = errorHandler;
```

## üîê Padr√µes de Seguran√ßa

### 1. Autentica√ß√£o JWT

```javascript
// Configura√ß√£o JWT
const JWT_CONFIG = {
  secret: process.env.JWT_SECRET,
  expiresIn: '24h',
  issuer: 'processflow-api',
  audience: 'processflow-app'
};

// Gera√ß√£o de token
const generateToken = (user) => {
  return jwt.sign(
    { 
      userId: user._id,
      username: user.username,
      role: user.role 
    },
    JWT_CONFIG.secret,
    {
      expiresIn: JWT_CONFIG.expiresIn,
      issuer: JWT_CONFIG.issuer,
      audience: JWT_CONFIG.audience
    }
  );
};
```

### 2. Middleware de Rate Limiting

```javascript
// app.js
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 100, // m√°ximo 100 requests por IP
  message: {
    success: false,
    error: 'Muitas tentativas, tente novamente em 15 minutos'
  },
  standardHeaders: true,
  legacyHeaders: false
});

app.use('/api', limiter);
```

### 3. Configura√ß√£o CORS

```javascript
// src/config/cors.js
const corsConfig = {
  origin: (origin, callback) => {
    const allowedOrigins = [
      'http://localhost:3000',
      'http://localhost:3001',
      'https://capacitar-frontend.vercel.app',
      'https://processflow.company.com'
    ];
    
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('N√£o permitido pelo CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
};

module.exports = corsConfig;
```

## üìù Padr√µes de Logging

### 1. Estrutura de Logs

```javascript
// N√≠veis de log
const LOG_LEVELS = {
  ERROR: '‚ùå',
  WARN: '‚ö†Ô∏è',
  INFO: '‚ÑπÔ∏è',
  SUCCESS: '‚úÖ',
  DEBUG: 'üîç'
};

// Helper de logging
const logger = {
  error: (message, meta = {}) => {
    console.error(`${LOG_LEVELS.ERROR} ${message}`, meta);
  },
  warn: (message, meta = {}) => {
    console.warn(`${LOG_LEVELS.WARN} ${message}`, meta);
  },
  info: (message, meta = {}) => {
    console.log(`${LOG_LEVELS.INFO} ${message}`, meta);
  },
  success: (message, meta = {}) => {
    console.log(`${LOG_LEVELS.SUCCESS} ${message}`, meta);
  },
  debug: (message, meta = {}) => {
    if (process.env.NODE_ENV === 'development') {
      console.log(`${LOG_LEVELS.DEBUG} ${message}`, meta);
    }
  }
};
```

### 2. Logs em Opera√ß√µes

```javascript
// Exemplo de uso em rotas
router.post('/', auth, async (req, res) => {
  try {
    logger.info(`Criando recurso - Usu√°rio: ${req.user.username}`);
    logger.debug('Dados recebidos:', req.body);
    
    const resource = await Model.create(req.body);
    
    logger.success(`Recurso criado: ${resource._id}`);
    
    res.status(201).json({
      success: true,
      data: resource
    });
    
  } catch (error) {
    logger.error('Erro ao criar recurso:', {
      message: error.message,
      user: req.user.username,
      data: req.body
    });
    
    res.status(500).json({
      success: false,
      error: 'Erro interno do servidor'
    });
  }
});
```

## üîÑ Versionamento de API

### 1. Estrutura de Vers√µes

```
/api/v1/users     # Vers√£o atual
/api/v2/users     # Nova vers√£o (quando necess√°rio)
```

### 2. Migra√ß√£o de Vers√µes

```javascript
// Middleware de versionamento
const apiVersion = (req, res, next) => {
  const version = req.headers['api-version'] || 'v1';
  req.apiVersion = version;
  next();
};

// Uso em rotas
app.use('/api/v1', require('./routes/v1'));
app.use('/api/v2', require('./routes/v2'));
```

## üìä Padroniza√ß√£o de Respostas

### 1. Estrutura de Resposta Padr√£o

```javascript
// Sucesso
{
  "success": true,
  "data": { /* dados */ },
  "message": "Opera√ß√£o realizada com sucesso",
  "pagination": { /* quando aplic√°vel */ }
}

// Erro
{
  "success": false,
  "error": "Mensagem de erro",
  "details": [ /* detalhes quando aplic√°vel */ ],
  "code": "ERROR_CODE" // opcional
}
```

### 2. Helper de Respostas

```javascript
// src/utils/responses.js
const responses = {
  success: (res, data, message = 'Sucesso', statusCode = 200) => {
    res.status(statusCode).json({
      success: true,
      data,
      message
    });
  },
  
  error: (res, error, statusCode = 500, details = null) => {
    res.status(statusCode).json({
      success: false,
      error,
      ...(details && { details })
    });
  },
  
  paginated: (res, data, pagination) => {
    res.json({
      success: true,
      data,
      pagination
    });
  }
};

module.exports = responses;
```

## üß™ Padr√µes de Teste

### 1. Estrutura de Testes

```javascript
// tests/routes/users.test.js
const request = require('supertest');
const app = require('../../app');
const User = require('../../src/models/User');

describe('Users Routes', () => {
  beforeEach(async () => {
    await User.deleteMany({});
  });

  describe('POST /api/v1/users', () => {
    it('deve criar um novo usu√°rio', async () => {
      const userData = {
        username: 'testuser',
        email: 'test@example.com',
        password: 'Test123!'
      };

      const response = await request(app)
        .post('/api/v1/users')
        .send(userData)
        .expect(201);

      expect(response.body.success).toBe(true);
      expect(response.body.data.username).toBe(userData.username);
    });

    it('deve retornar erro para dados inv√°lidos', async () => {
      const response = await request(app)
        .post('/api/v1/users')
        .send({})
        .expect(422);

      expect(response.body.success).toBe(false);
    });
  });
});
```

## üìö Documenta√ß√£o de API

### 1. Swagger/OpenAPI

```javascript
// swagger.js
const swaggerJsdoc = require('swagger-jsdoc');

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'ProcessFlow API',
      version: '1.0.0',
      description: 'API para sistema de gest√£o de processos'
    },
    servers: [
      {
        url: 'http://localhost:5000/api/v1',
        description: 'Servidor de desenvolvimento'
      }
    ],
  },
  apis: ['./src/routes/*.js'],
};

const specs = swaggerJsdoc(options);
module.exports = specs;
```

### 2. Documenta√ß√£o inline

```javascript
/**
 * @swagger
 * /users:
 *   post:
 *     summary: Criar novo usu√°rio
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - username
 *               - email
 *               - password
 *             properties:
 *               username:
 *                 type: string
 *                 minLength: 3
 *                 maxLength: 30
 *               email:
 *                 type: string
 *                 format: email
 *               password:
 *                 type: string
 *                 minLength: 6
 *     responses:
 *       201:
 *         description: Usu√°rio criado com sucesso
 *       422:
 *         description: Dados inv√°lidos
 */
```

## ‚úÖ Checklist para Pull Requests

### C√≥digo
- [ ] Seguiu os padr√µes de nomenclatura estabelecidos
- [ ] Implementou logging adequado
- [ ] Adicionou tratamento de erros
- [ ] Valida√ß√£o de entrada implementada
- [ ] Documenta√ß√£o inline (JSDoc/Swagger) adicionada

### Seguran√ßa
- [ ] Autentica√ß√£o/autoriza√ß√£o implementada
- [ ] Valida√ß√£o de permiss√µes
- [ ] Sanitiza√ß√£o de entrada
- [ ] Rate limiting considerado

### Banco de Dados
- [ ] Esquemas seguem padr√µes estabelecidos
- [ ] √çndices necess√°rios criados
- [ ] Relacionamentos definidos corretamente
- [ ] Valida√ß√µes no schema implementadas

### Testes
- [ ] Testes unit√°rios escritos
- [ ] Casos de erro testados
- [ ] Testes de integra√ß√£o (quando necess√°rio)
- [ ] Coverage de teste adequado

### Performance
- [ ] Queries otimizadas
- [ ] Pagina√ß√£o implementada (quando necess√°rio)
- [ ] Population de campos essencial
- [ ] Caching considerado

### Documenta√ß√£o
- [ ] README atualizado (se necess√°rio)
- [ ] Documenta√ß√£o da API atualizada
- [ ] Coment√°rios explicativos em c√≥digo complexo
- [ ] Changelog atualizado

## üöÄ Pr√≥ximos Passos de Evolu√ß√£o

### 1. Implementa√ß√µes Recomendadas

#### Sistema de Cache (Redis)
```javascript
const redis = require('redis');
const client = redis.createClient(process.env.REDIS_URL);

const cache = {
  get: async (key) => {
    const data = await client.get(key);
    return data ? JSON.parse(data) : null;
  },
  
  set: async (key, data, ttl = 3600) => {
    await client.setex(key, ttl, JSON.stringify(data));
  }
};
```

#### Sistema de Filas (Bull)
```javascript
const Queue = require('bull');
const emailQueue = new Queue('email processing');

emailQueue.process(async (job) => {
  const { email, template, data } = job.data;
  await sendEmail(email, template, data);
});
```

#### Monitoramento (Prometheus)
```javascript
const prometheus = require('prom-client');

const httpRequestDuration = new prometheus.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status']
});
```

### 2. Estrutura para Microservi√ßos

```
services/
‚îú‚îÄ‚îÄ auth-service/
‚îú‚îÄ‚îÄ user-service/
‚îú‚îÄ‚îÄ process-service/
‚îî‚îÄ‚îÄ notification-service/
```

### 3. CI/CD Pipeline

```yaml
# .github/workflows/ci.yml
name: CI/CD
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
      - run: npm install
      - run: npm test
      - run: npm run lint
```

---

## üìû Suporte

Para d√∫vidas sobre estes padr√µes ou sugest√µes de melhoria, consulte a equipe de desenvolvimento ou abra uma issue no reposit√≥rio.

**√öltima atualiza√ß√£o**: Janeiro 2025
**Vers√£o**: 1.0.0
